<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
											
<mapper namespace="com.project.gwasil_zero.mapper.AdminMapper">
	<select id="selectNewMemList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.User">
		SELECT *
		FROM (
			SELECT *
			FROM TBL_USER
			ORDER BY CDATE DESC
		)
		WHERE ROWNUM &lt;= 5
	</select>	
	
	<select id="selectLawAdminWaitList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Lawyer">
		SELECT *
		FROM LAWYER
		WHERE LAWYER_PASS = 'N' AND ROWNUM &lt;= 5
	</select>
	
	<select id="selectRepoAdminList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Report">
		SELECT *
		FROM (
		    SELECT *
		    FROM REPORT
		    WHERE REPORT_STATUS != 'DELETE'
		    ORDER BY CDATE DESC
		)
		WHERE ROWNUM &lt;= 5
	</select>	
	
	<select id="selectUserList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.User">
		SELECT
	        U.USER_ID,
	        U.USER_NAME,
	        U.USER_STATUS,
	        U.REPORT_CNT,
	        U.CDATE,
	        (
	            SELECT MAX(PACKAGE_NAME)
	            FROM PAY P
	            WHERE P.USER_ID = U.USER_ID
	        ) AS PACKAGE_NAME
	    FROM TBL_USER U
	    WHERE 1=1
	
	    <!-- 회원 상태 필터 -->
	    <if test="status != null and status != 'ALL'">
	        <choose>
	            <when test="status == 'Out'">
	                AND U.USER_STATUS = 'OUT'
	            </when>
	            <when test="status == 'paid'">
	                AND U.USER_STATUS = 'NORMAL'
	                AND EXISTS (
	                    SELECT 1 FROM PAY P WHERE P.USER_ID = U.USER_ID
	                )
	            </when>
	            <when test="status == 'free'">
	                AND U.USER_STATUS = 'NORMAL'
	                AND NOT EXISTS (
	                    SELECT 1 FROM PAY P WHERE P.USER_ID = U.USER_ID
	                )
	            </when>
	        </choose>
	    </if>
	
	    <!-- 가입일 조건 -->
	    <if test="period != null and period != 'ALL'">
	        <choose>
	            <when test="period == 'WEEK'">
	                AND U.CDATE &gt;= SYSDATE - 7
	            </when>
	            <when test="period == 'MONTH'">
	                AND U.CDATE &gt;= ADD_MONTHS(SYSDATE, -1)
	            </when>
	            <when test="period == 'YEAR'">
	                AND U.CDATE &gt;= ADD_MONTHS(SYSDATE, -12)
	            </when>
	        </choose>
	    </if>
	
	    <!-- 검색어 (이름 또는 패키지명) -->
	    <if test="word != null and word != ''">
	        AND (
	            U.USER_NAME LIKE '%' || #{word} || '%'
	            OR EXISTS (
	                SELECT 1 FROM PAY P
	                WHERE P.USER_ID = U.USER_ID
	                AND P.PACKAGE_NAME LIKE '%' || #{word} || '%'
	            )
	        )
	    </if>
	
	    ORDER BY U.CDATE DESC
	    OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="userCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*)
	    FROM TBL_USER U
	    WHERE 1=1
	
	    <if test="status != null and status != 'ALL'">
	        <choose>
	            <when test="status == 'Out'">
	                AND U.USER_STATUS = 'OUT'
	            </when>
	            <when test="status == 'paid'">
	                AND U.USER_STATUS = 'NORMAL'
	                AND EXISTS (
	                    SELECT 1 FROM PAY P WHERE P.USER_ID = U.USER_ID
	                )
	            </when>
	            <when test="status == 'free'">
	                AND U.USER_STATUS = 'NORMAL'
	                AND NOT EXISTS (
	                    SELECT 1 FROM PAY P WHERE P.USER_ID = U.USER_ID
	                )
	            </when>
	        </choose>
	    </if>
	
	    <if test="period != null and period != 'ALL'">
	        <choose>
	            <when test="period == 'WEEK'">
	                AND U.CDATE &gt;= SYSDATE - 7
	            </when>
	            <when test="period == 'MONTH'">
	                AND U.CDATE &gt;= ADD_MONTHS(SYSDATE, -1)
	            </when>
	            <when test="period == 'YEAR'">
	                AND U.CDATE &gt;= ADD_MONTHS(SYSDATE, -12)
	            </when>
	        </choose>
	    </if>
	
	    <if test="word != null and word != ''">
	        AND (
	            U.USER_NAME LIKE '%' || #{word} || '%'
	            OR EXISTS (
	                SELECT 1 FROM PAY P
	                WHERE P.USER_ID = U.USER_ID
	                AND P.PACKAGE_NAME LIKE '%' || #{word} || '%'
	            )
	        )
	    </if>
	</select>	
	
	<select id="selectLawWaitList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Lawyer">
		SELECT *
		FROM LAWYER
		WHERE LAWYER_PASS = 'N'
			AND LAWYER_STATUS != 'O'
		ORDER BY LAWYER_NAME
		OFFSET #{waitPage} ROWS FETCH NEXT #{waitPageSize} ROWS ONLY
	</select>
	
	<select id="selectLawWaitCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	    FROM LAWYER
	    WHERE LAWYER_PASS = 'N'
	    	AND LAWYER_STATUS != 'O'
	</select>
	
	<update id="updateLawyerPass" parameterType="hashmap">
	    UPDATE LAWYER
	    SET LAWYER_PASS = 'Y'
	    WHERE LAWYER_ID = #{lawyerId}
	</update>
	
	<select id="selectLawPassedList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Lawyer">
		SELECT *
		FROM LAWYER
		WHERE LAWYER_PASS = 'Y'
			AND LAWYER_STATUS != 'O'
		ORDER BY LAWYER_NAME
		OFFSET #{passedPage} ROWS FETCH NEXT #{passedPageSize} ROWS ONLY
	</select>
	
	<select id="selectLawPassedCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	    FROM LAWYER
	    WHERE LAWYER_PASS = 'Y'
	    	AND LAWYER_STATUS != 'O'
	</select>
	
	<update id="updateLawyerCencel" parameterType="hashmap">
	    UPDATE LAWYER
	    SET LAWYER_PASS = 'N'
	    WHERE LAWYER_ID = #{lawyerId}
	</update>
	
	<select id="selectLawOutList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Lawyer">
		SELECT *
		FROM LAWYER
		WHERE LAWYER_STATUS = 'O'
		ORDER BY LAWYER_NAME
		OFFSET #{outPage} ROWS FETCH NEXT #{outPageSize} ROWS ONLY
	</select>
	
	<select id="selectLawOutCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	    FROM LAWYER
	    WHERE LAWYER_STATUS = 'O'
	</select>
	
	<update id="updateLawyerComeBack" parameterType="hashmap">
	    UPDATE LAWYER
	    SET LAWYER_STATUS = 'I'
	    WHERE LAWYER_ID = #{lawyerId}
	</update>
	
	<select id="selectReportList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Report">
		SELECT *
		FROM REPORT
		ORDER BY BOARD_NO
		OFFSET #{repoPage} ROWS FETCH NEXT #{repoPageSize} ROWS ONLY
	</select>
	
	<select id="selectReportCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	    FROM REPORT
	</select>
	
	<update id="updateReportStatus" parameterType="hashmap">
	    UPDATE REPORT
	    SET REPORT_STATUS = #{reportStatus}
	    WHERE REPORT_NO = #{reportNo}
	</update>
	
	<select id="selectStatChart" parameterType="hashmap" resultType="hashmap">
	    SELECT 
	        PACKAGE_NAME,
	        TO_CHAR(PAY_TIME,
	        <choose>
	            <when test="groupType == 'daily'"> 'YY/MM/DD' </when>
	            <when test="groupType == 'monthly'"> 'YY/MM' </when>
	            <otherwise> 'YY' </otherwise>
	        </choose>
	        ) AS TIME_GROUP,
	        SUM(TO_NUMBER(PRICE)) AS TOTAL_PRICE
	    FROM PAY
	    WHERE PAY_STATUS = 'PAID'
	      AND REGEXP_LIKE(PRICE, '^\d+$')
	    <if test="startDate != null and endDate != null and startDate != '' and endDate != ''">
	        AND PAY_TIME BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	    </if>
	    GROUP BY 
	        PACKAGE_NAME,
	        TO_CHAR(PAY_TIME,
	        <choose>
	            <when test="groupType == 'daily'"> 'YY/MM/DD' </when>
	            <when test="groupType == 'monthly'"> 'YY/MM' </when>
	            <otherwise> 'YY' </otherwise>
	        </choose>
	        )
	    ORDER BY TIME_GROUP
	</select>

</mapper>