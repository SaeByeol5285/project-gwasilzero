<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gwasil_zero.mapper.MypageMapper">
  	
	<select id="selectUserBoardList" parameterType="hashmap" resultType="hashmap">
	    SELECT
	        B.BOARD_NO AS boardNo,
	        B.BOARD_TITLE AS boardTitle,
	        B.CONTENTS AS contents,
	        F.FILE_PATH || '/' || F.FILE_REALNAME AS thumb
	    FROM
	        BOARD B
	    LEFT JOIN BOARD_FILE F ON B.BOARD_NO = F.BOARD_NO AND F.THUMBNAIL = 'Y'
	    WHERE
	        B.USER_ID = #{userId}
	    ORDER BY B.CDATE DESC
	</select>
	
	<select id="selectUserChatList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Chat">
	    SELECT 
	        C.CHAT_NO            AS chatNo,
	        L.LAWYER_NAME        AS lawyerName,
	        M.MESSAGE            AS message,
	        TO_CHAR(M.TIME, 'YYYY-MM-DD HH24:MI') AS chatTime
	    FROM 
	        CHAT C
	    JOIN CHAT_MESSAGE M ON C.CHAT_NO = M.CHAT_NO
	    JOIN LAWYER L ON C.RECEIVER_ID = L.LAWYER_ID
	    WHERE 
	        C.SENDER_ID = #{userId}
	        AND M.TIME = (
	            SELECT MAX(TIME) FROM CHAT_MESSAGE WHERE CHAT_NO = C.CHAT_NO
	        )
	    ORDER BY M.TIME DESC
	</select>
	
	
	<select id="selectMyPayList" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Pay">
	    SELECT *
	    FROM PAY
	   	WHERE USER_ID = #{userId}
	    
	</select>
	
	<select id="selectUserForMypage" parameterType="hashmap" resultType="com.project.gwasil_zero.model.User">
	    SELECT USER_NAME, USER_PHONE, USER_EMAIL, USER_ID
	    FROM TBL_USER
	    WHERE USER_ID = #{userId}
	</select>
  
	<update id="updateUserInfo" parameterType="hashmap">
	    UPDATE TBL_USER
	    SET
	        USER_NAME = #{userName},
	        USER_PHONE = #{userPhone},
	        USER_EMAIL = #{userEmail}
	    WHERE USER_ID = #{userId}
	</update>
	
	<select id="selectUserInfo" parameterType="hashmap" resultType="com.project.gwasil_zero.model.User">
	    SELECT USER_ID, USER_NAME, USER_PHONE, USER_EMAIL
	    FROM TBL_USER
	    WHERE USER_ID = #{sessionId}
	</select>
	
	<!-- 비밀번호 확인용 -->
	<select id="selectUserById" parameterType="hashmap" resultType="com.project.gwasil_zero.model.User">
	    SELECT *
	    FROM TBL_USER
	    WHERE USER_ID = #{userId}
	</select>

	<!-- 탈퇴 처리 (user_status 변경 or 삭제) -->
	<update id="deleteUserByAdmin" parameterType="hashmap">
	    UPDATE TBL_USER
	    SET USER_STATUS = 'OUT',
	        CDATE = SYSDATE
	    WHERE USER_ID = #{userId}
	</update>   
   
   <select id="selectLawyerInfo" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Lawyer">
      SELECT *
      FROM LAWYER
      WHERE LAWYER_ID = #{sessionId}
   </select>
   
   <update id="updateLawyer" parameterType="hashmap">
      UPDATE LAWYER
      SET
         LAWYER_NAME = #{lawyerName},
         LAWYER_PHONE = #{lawyerPhone},
         LAWYER_EMAIL = #{lawyerEmail}
      WHERE LAWYER_ID = #{sessionId}
   </update>
   
   <update id="deleteLawyer" parameterType="hashmap">
      UPDATE LAWYER
      SET
         LAWYER_STATUS = 'O'
      WHERE LAWYER_ID = #{sessionId}
   </update>
   
   <update id="updateCounsel" parameterType="hashmap">
      UPDATE LAWYER
      SET
         COUNSEL = #{counsel}
      WHERE LAWYER_ID = #{lawyerId}
   </update>
   
   <select id="selectLawyerBoard" parameterType="hashmap" resultType="Board">
	    SELECT B.*, U.USER_NAME
	    FROM BOARD B
	    INNER JOIN TBL_USER U ON B.USER_ID = U.USER_ID
	    WHERE 1=1
	    <if test="sessionId != null and sessionId != ''">
	        AND B.LAWYER_ID = #{sessionId}
	    </if>
	    <if test="boardStatus != null and boardStatus != ''">
	        AND B.BOARD_STATUS = #{boardStatus}
	    </if>
	    offset #{page} rows fetch next #{pageSize} rows only
	</select>
	
	<select id="selectBoardCnt" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	    FROM BOARD B
	    INNER JOIN TBL_USER U ON B.USER_ID = U.USER_ID
	    WHERE 1=1
	    <if test="sessionId != null and sessionId != ''">
	        AND B.LAWYER_ID = #{sessionId}
	    </if>
	    <if test="boardStatus != null and boardStatus != ''">
	        AND B.BOARD_STATUS = #{boardStatus}
	    </if>
	</select>
	
	<update id="updateBoardStatus" parameterType="hashmap">
      UPDATE BOARD
      SET
         BOARD_STATUS = #{boardStatus}
      WHERE BOARD_NO = #{boardNo}
    </update>
    
    <select id="selectLawyerPay" parameterType="hashmap" resultType="com.project.gwasil_zero.model.Pay">
      SELECT *
      FROM PAY
      WHERE LAWYER_ID = #{sessionId} 
   </select>
   
   <update id="updatePayStatus" parameterType="hashmap">
      UPDATE PAY
      SET
         PAY_STATUS = 'REQUEST'
      WHERE ORDER_ID = #{orderId}
    </update>
    
    <update id="updateCancel" parameterType="hashmap">
      UPDATE PAY
      SET
         PAY_STATUS = 'PAID'
      WHERE ORDER_ID = #{orderId}
    </update>
    
    <select id="selectLastChat" parameterType="hashmap" resultType="com.project.gwasil_zero.model.ChatMessage">
	    SELECT cm.chat_no,
	           cm.sender_id,
	           u.user_name AS sender_name,
	           cm.message,
	           TO_CHAR(cm.time, 'YYYY-MM-DD HH24:MI:SS') AS time,
	
	           CASE 
	               WHEN c.sender_id = #{sessionId} THEN u2.user_name
	               ELSE u1.user_name
	           END AS partner_name
	    FROM chat_message cm
	    JOIN (
	        SELECT chat_no, MAX(time) AS max_time
	        FROM chat_message
	        WHERE chat_no IN (
	            SELECT chat_no
	            FROM chat
	            WHERE sender_id = #{sessionId}
	               OR receiver_id = #{sessionId}
	        )
	        GROUP BY chat_no
	    ) latest ON cm.chat_no = latest.chat_no AND cm.time = latest.max_time
	    JOIN chat c ON cm.chat_no = c.chat_no
	    LEFT JOIN tbl_user u ON cm.sender_id = u.user_id
	    LEFT JOIN tbl_user u1 ON c.sender_id = u1.user_id
	    LEFT JOIN tbl_user u2 ON c.receiver_id = u2.user_id
	    ORDER BY cm.time DESC
	</select>

    
</mapper>